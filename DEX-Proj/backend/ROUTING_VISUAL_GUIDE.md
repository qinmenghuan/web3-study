# DEX 多跳交易路由可视化指南

## 🎯 核心概念速览

### 1. 流动性池结构

```
┌─────────────────────────────────────┐
│      流动性池 (Liquidity Pool)      │
├─────────────────────────────────────┤
│                                     │
│   Token A: 75,000 WETH             │
│   Token B: 180,000,000 USDC        │
│                                     │
│   恒定乘积: k = x × y              │
│   k = 75,000 × 180,000,000         │
│   k = 13,500,000,000,000           │
│                                     │
│   当前价格:                         │
│   1 WETH = 2,400 USDC              │
│                                     │
└─────────────────────────────────────┘
```

### 2. 恒定乘积公式

```
交易前: x₀ × y₀ = k

交易后: x₁ × y₁ = k

其中: x₁ = x₀ + Δx (加入代币A)
      y₁ = y₀ - Δy (取出代币B)

因此: (x₀ + Δx) × (y₀ - Δy) = x₀ × y₀

解得: Δy = (y₀ × Δx) / (x₀ + Δx)

考虑手续费:
      Δy = (y₀ × Δx × (1-fee)) / (x₀ + Δx × (1-fee))
```

---

## 📊 交易路径类型

### 类型 1: 单跳交易（Direct Swap）

```
用户输入 10 WETH，想兑换 USDC

┌─────────┐         ┌──────────────────┐         ┌─────────┐
│         │         │  流动性池        │         │         │
│  用户   │─ 10 ───▶│  WETH/USDC      │───23,924─▶│  用户   │
│         │  WETH   │                  │   USDC   │         │
└─────────┘         │  75k / 180M      │         └─────────┘
                    │  手续费: 0.3%    │
                    │  流动性: $360M   │
                    └──────────────────┘

优点:
✅ 手续费最低 (只扣一次)
✅ Gas 费用最低
✅ 计算最简单
✅ 滑点可控

缺点:
❌ 某些代币对可能不存在直接池子
❌ 流动性可能不足
```

### 类型 2: 两跳交易（Two-Hop Swap）

```
用户输入 10 WETH，想兑换 DAI（没有直接池子）

                    第一跳              第二跳
┌─────────┐    ┌────────────┐    ┌────────────┐    ┌─────────┐
│         │    │ Pool 1     │    │ Pool 2     │    │         │
│  用户   │─10─▶│ WETH/USDC │─23,924─▶│ USDC/DAI  │─23,839─▶│  用户   │
│         │WETH│            │  USDC │            │  DAI  │         │
└─────────┘    │ 75k/180M   │    │ 42M/42M    │    └─────────┘
               │ $360M      │    │ $84M       │
               │ fee:0.3%   │    │ fee:0.3%   │
               └────────────┘    └────────────┘

路径: WETH → USDC → DAI

优点:
✅ 可以连接任意两个代币
✅ 可能获得更好的价格
✅ 分散流动性风险

缺点:
❌ 手续费更高 (0.3% + 0.3% ≈ 0.6%)
❌ Gas 费用翻倍
❌ 滑点累积
```

### 类型 3: 多路径交易（Multi-Path Swap）

```
用户输入 100 WETH，拆分到多个路径以降低滑点

                     路径 1: 40 WETH
          ┌─────────────────────────────────┐
          │                                 │
          │  Pool A: WETH/USDC             │
          │  输出: 95,600 USDC             │
          │                                 │
┌────┐    ├─────────────────────────────────┤    ┌────┐
│100 │    │  路径 2: 35 WETH               │    │总计│
│WETH│────┤                                 │────│USDC│
│    │    │  Pool B: WETH→USDT→USDC        │    │    │
└────┘    │  输出: 83,800 USDC             │    └────┘
          │                                 │
          ├─────────────────────────────────┤
          │  路径 3: 25 WETH               │
          │                                 │
          │  Pool C: WETH→DAI→USDC         │
          │  输出: 59,750 USDC             │
          │                                 │
          └─────────────────────────────────┘

总输出: 239,150 USDC
平均价格: 2,391.5 USDC/WETH

优点:
✅ 大额交易滑点更小
✅ 获得更好的平均价格
✅ 风险分散

缺点:
❌ Gas 费用最高
❌ 实现复杂
❌ 需要精确的最优化算法
```

---

## 🔍 路径搜索过程

### 两跳路由搜索流程图

```
开始: 想要从 Token A 兑换到 Token Z

第一步: 查找所有从 A 出发的池子
┌─────┐
│  A  │───────┐
└─────┘       │
              ├───▶ Pool 1: A/B  ───▶ Token B
              │
              ├───▶ Pool 2: A/C  ───▶ Token C
              │
              ├───▶ Pool 3: A/D  ───▶ Token D
              │
              └───▶ Pool 4: A/E  ───▶ Token E

第二步: 对每个中间代币，查找到 Z 的池子
┌─────┐                  ┌─────┐
│  B  │───▶ Pool 5: B/Z ───▶│  Z  │✅ 路径 1
└─────┘                  └─────┘

┌─────┐                  ┌─────┐
│  C  │───▶ Pool 6: C/Z ───▶│  Z  │✅ 路径 2
└─────┘                  └─────┘

┌─────┐
│  D  │───▶ 没有池子 ───▶ ❌ 路径不通
└─────┘

┌─────┐                  ┌─────┐
│  E  │───▶ Pool 7: E/Z ───▶│  Z  │✅ 路径 3
└─────┘                  └─────┘

第三步: 评估所有可行路径
路径 1: A → B → Z  (流动性: $100M, 手续费: 0.6%)
路径 2: A → C → Z  (流动性: $50M,  手续费: 0.6%)
路径 3: A → E → Z  (流动性: $200M, 手续费: 0.6%)

第四步: 选择最优路径
✅ 路径 3 (流动性最高)
```

---

## 💡 最优路径选择算法

### 决策树

```
                    开始评估路径
                         │
         ┌───────────────┼───────────────┐
         │               │               │
    是否为直接      流动性是否       手续费是否
    交易路径？      足够高？          可接受？
         │               │               │
    ┌────┴────┐     ┌────┴────┐     ┌────┴────┐
    是        否     是        否     是        否
    │         │      │         │      │         │
    优先      │      继续      │      接受      │
    选择      │      评估      │      路径      │
              │                │                │
              └────────────────┴────────────────┘
                         │
                    计算综合得分
                         │
              ┌──────────┼──────────┐
              │          │          │
          流动性得分  手续费得分  价格得分
           (40%)      (30%)      (30%)
              │          │          │
              └──────────┼──────────┘
                         │
                  选择得分最高的路径
```

### 评分公式

```
综合得分 = 流动性得分 × 0.4 + 手续费得分 × 0.3 + 价格得分 × 0.3

流动性得分 = normalize(瓶颈流动性, min=1M, max=100M) × 100

手续费得分 = (1 - 总手续费) × 100

价格得分 = (实际输出 / 理论输出) × 100

示例:
路径 A: 流动性 $50M, 手续费 0.3%, 输出 99%
  = normalize(50M) × 0.4 + (1-0.003)×100 × 0.3 + 99 × 0.3
  = 75 × 0.4 + 99.7 × 0.3 + 99 × 0.3
  = 30 + 29.91 + 29.7
  = 89.61 分

路径 B: 流动性 $100M, 手续费 0.6%, 输出 98%
  = normalize(100M) × 0.4 + (1-0.006)×100 × 0.3 + 98 × 0.3
  = 100 × 0.4 + 99.4 × 0.3 + 98 × 0.3
  = 40 + 29.82 + 29.4
  = 99.22 分 ✅ 最优
```

---

## 📈 价格影响与滑点

### 小额交易 vs 大额交易

```
池子状态: 75,000 WETH / 180,000,000 USDC
理论价格: 1 WETH = 2,400 USDC

小额交易 (1 WETH):
┌──────────────────────────────────┐
│ 输入: 1 WETH                     │
│ 输出: 2,392.81 USDC              │
│ 实际价格: 2,392.81 USDC/WETH     │
│ 滑点: -0.30%                     │
│ 价格影响: 很小 ✅                │
└──────────────────────────────────┘

中额交易 (10 WETH):
┌──────────────────────────────────┐
│ 输入: 10 WETH                    │
│ 输出: 23,924.81 USDC             │
│ 实际价格: 2,392.48 USDC/WETH     │
│ 滑点: -0.31%                     │
│ 价格影响: 较小 ✅                │
└──────────────────────────────────┘

大额交易 (1,000 WETH):
┌──────────────────────────────────┐
│ 输入: 1,000 WETH                 │
│ 输出: 2,367,788 USDC             │
│ 实际价格: 2,367.79 USDC/WETH     │
│ 滑点: -1.34%                     │
│ 价格影响: 较大 ⚠️                │
└──────────────────────────────────┘

超大额交易 (10,000 WETH):
┌──────────────────────────────────┐
│ 输入: 10,000 WETH                │
│ 输出: 21,176,471 USDC            │
│ 实际价格: 2,117.65 USDC/WETH     │
│ 滑点: -11.77%                    │
│ 价格影响: 非常大 ❌              │
│ 建议: 拆分订单或使用多路径       │
└──────────────────────────────────┘
```

---

## 🛠️ 实际应用策略

### 策略 1: 根据交易金额选择路径

```
if 交易金额 < 1 ETH:
    → 选择手续费最低的路径
    → 单跳优先
    
elif 1 ETH ≤ 交易金额 < 100 ETH:
    → 平衡手续费和流动性
    → 考虑单跳和两跳
    
else:  # > 100 ETH
    → 优先考虑流动性深度
    → 可能需要多路径拆分
    → 接受稍高的手续费
```

### 策略 2: 动态路由更新

```
时间线:
t=0s    查询最优路径 → 路径 A (输出 100 USDC)
        ↓
t=5s    用户确认交易
        ↓
t=10s   ⚠️ 检测: 路径 A 流动性下降 50%
        ↓ 重新计算
        ↓
        新路径 B (输出 99 USDC)
        ↓
t=11s   提示用户: "价格变化，输出从 100 降到 99"
        ↓
        用户选择: 接受 or 取消
```

### 策略 3: 智能滑点保护

```
用户设置: 最大滑点 1%

┌─────────────────────────────────────┐
│  预估输出: 100 USDC                 │
│  最小接受: 99 USDC (1% 滑点)        │
│                                     │
│  交易执行中...                      │
│                                     │
│  if 实际输出 >= 99 USDC:            │
│      ✅ 交易成功                    │
│  else:                              │
│      ❌ 交易回滚                    │
│      (保护用户免受 MEV 攻击)        │
└─────────────────────────────────────┘
```

---

## 🎓 关键要点总结

### ✅ 核心原理

1. **恒定乘积公式** - AMM 的数学基础
   ```
   x × y = k (常数)
   ```

2. **多跳路由** - 通过中间代币连接不同市场
   ```
   A → B → C (两跳)
   A → B → C → D (三跳)
   ```

3. **流动性深度** - 决定价格滑点的关键因素
   ```
   流动性越高 → 滑点越小 → 价格越好
   ```

### ✅ 优化策略

1. **路径搜索**: 使用数据库索引 + SQL CTE
2. **性能优化**: 设置流动性阈值剪枝
3. **动态选择**: 根据交易金额调整策略
4. **风险控制**: 滑点保护 + 多路径分散

### ✅ 实际应用

1. 小额交易: 优先单跳，降低 Gas
2. 中额交易: 平衡手续费和流动性
3. 大额交易: 多路径拆分，降低滑点
4. 实时监控: 池子状态变化，动态调整

---

## 📚 延伸阅读

- `ROUTING_ALGORITHM.md` - 详细的算法原理和数学推导
- `examples/routing_example.go` - 可运行的代码示例
- `api/bot.go` - 实际的路由查询实现

---

**提示**: 运行 `go run examples/routing_example.go` 查看实际计算过程！

